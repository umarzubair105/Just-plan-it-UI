<div class="container-fluid px-4">

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="bi bi-kanban me-2"></i> {{ messageChange('Product') }} Release History</h4>
    </div>
    <div class="card-body bg-white">
      <div class="d-flex">
        <ul class="navbar-nav d-flex flex-row flex-wrap gap-2 mb-2 mb-lg-0 ms-auto">
          <li class="nav-item" *ngFor="let releaseDetailLink of releases;let i = index">
            <a [routerLink]="[]" [fragment]="'eRelease'+i" class="nav-link px-2" *ngIf="i>0">
              {{ releaseDetailLink.release?.name }}</a>
          </li>
        </ul>
      </div>
      <div class="row release" *ngFor="let releaseDetail of releases;let i = index" [id]="'eRelease'+i">
        <!-- Release Details -->
        <div class="mb-4 p-2 border rounded d-flex justify-content-between align-items-center flex-wrap release-info">
          <div class="release-info-text text-dark text-center">
            Release: {{ releaseDetail.release?.name }} &nbsp;|&nbsp;
            Start Date: <strong>{{ releaseDetail.release?.startDate }}</strong> &nbsp;|&nbsp;
            End Date: <strong>{{ releaseDetail.release?.endDate }}</strong> &nbsp;|&nbsp;
            Working Days: {{ releaseDetail.release?.workingDays }} &nbsp;|&nbsp;
            Status: <span [ngClass]="releaseStatusClass(releaseDetail.release.status)">{{ releaseDetail.release.status | titlecase }}</span>
          </div>

          <div class="mt-2 mt-lg-0">
            <button class="btn btn-sm btn-outline-success me-2" title="Expand the release"
                    *ngIf="!releaseDetail.expanded"
                    (click)="expand(releaseDetail)">
              <i class="bi bi-arrows-angle-expand"></i> Expand
            </button>
            <button class="btn btn-sm btn-outline-success me-2" title="Collapse the release"
                    *ngIf="releaseDetail.expanded"
                    (click)="releaseDetail.expanded=false;">
              <i class="bi bi-arrows-angle-contract"></i> Collapse
            </button>
            <button class="btn btn-outline-secondary btn-sm"
                    (click)="openDialogForEntityDetail(releaseDetail.release)" title="Release Artifacts">
              <i class="bi bi-file-earmark"></i> Release Artifacts
            </button>
          </div>
        </div>
        <div class="table-responsive mb-2" *ngIf="releaseDetail.expanded && releaseDetail.epics && releaseDetail.epics.length>0">
          <table class="table table-bordered table-hover align-middle compact-table">
            <thead class="table-light">
            <tr>
              <th>&nbsp;</th>
              <th>Code</th>
              <th>Title</th>
              <th>Depends On</th>
              <th>Related To</th>
              <th>Priority</th>
              <th>Required By</th>
              <th>Value Gain</th>
              <th class="text-center">Artifacts</th>
            </tr>
            </thead>
            <tbody>
            <ng-container *ngFor="let row of releaseDetail.epics">
              <tr>
                <td>
                  <button (click)="toggleAssignments(row)">
                    <i [ngClass]="{'bi bi-toggle-on': row.expanded, 'bi bi-toggle-off': !row.expanded}"></i></button>
                </td>
                <td><i class="{{epicAssignmentStatusIconClass(row.assignments)}}"></i>{{ row.code }}</td>
                <td>{{ row.title }}</td>
                <td>
                  <div [innerHTML]="relationData(row.dependsOn, EpicLinkType.DEPEND_ON, false)"
                       *ngIf="row.dependsOn && row.dependsOn.length>0"></div>
                </td>
                <td>
                  <div [innerHTML]="relationData(row.relatedTo, EpicLinkType.RELATED_TO, false)"
                       *ngIf="row.relatedTo && row.relatedTo.length>0"></div>
                </td>
                <td>{{ row.priorityName }}</td>
                <td>{{ row.requiredBy }}</td>
                <td>{{ row.valueGain }}</td>
                <td class="text-center">
                  <a (click)="openDialogForEpic(row)" title="View achievements">
                    <i class="bi bi-box-seam action-icon"></i>
                  </a>
                </td>
              </tr>
              <tr *ngIf="row.expanded">
                <td colspan="10">
                  <table class="table table-bordered table-hover align-middle mb-0 compact-table">
                    <thead class="table-light">
                    <tr>
                      <th>Resource</th>
                      <th>Estimated Time</th>
                      <th>Logged Time</th>
                      <th>Status</th>
                      <th>Due Date</th>
                    </tr>
                    </thead>
                    <tbody>
                    <ng-container *ngFor="let assignment of row.assignments">
                      <tr class="{{assignmentStatusClass(assignment)}}">
                        <td>{{ assignment.resourceName }}</td>
                        <td>{{ assignment.estimate | decimalToTime }}</td>
                        <td>{{ assignment.minutesLogged | decimalToTime }}</td>
                        <td [innerHTML]="assignmentStatusShow(assignment)"></td>
                        <td>{{ assignment.expectedDeliveryDate }}</td>
                      </tr>
                    </ng-container>
                    </tbody>
                  </table>
                </td>
              </tr>
            </ng-container>
            </tbody>
          </table>

        </div>
        <!-- Resource Allocation -->
        <!--
                  <h5 class="mb-1"><i class="bi bi-people me-2"></i> Resource Allocation</h5>
        -->
        <div class="table-responsive" *ngIf="releaseDetail.expanded && releaseDetail.epics && releaseDetail.epics.length>0">
          <table class="table table-bordered table-hover align-middle compact-table">
            <thead class="table-light">
            <tr>
              <td>Resource</td>
              <td>Availability</td>
              <td>Time Assigned</td>
              <td>Time Unassigned</td>
              <td>Time Logged</td>
              <td>Estimated Time - Utilized</td>
              <td>Available Time - Utilized</td>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let row of releaseDetail.resourceCaps">
              <td>{{ row.resourceName }}</td>
              <td>{{ row.prodBasedAssignableTime | decimalToTime }}</td>
              <td>{{ row.prodBasedAssignedTime | decimalToTime }}</td>
              <td>{{ row.prodBasedAssignableTime - row.prodBasedAssignedTime | decimalToTime }}</td>
              <td>{{ row.loggedTime | decimalToTime }}</td>
              <td>
                <div class="progress m-0" style="height: 18px;">
                  <div class="progress-bar" role="progressbar"
                       [ngClass]="{'bg-danger': getLoggedPercentageAgainstEstimated(row)>100,
                              'bg-primary': getLoggedPercentageAgainstEstimated(row)<=100}"
                       [style.width.%]="getLoggedPercentageAgainstEstimated(row)"
                       aria-valuemin="0"
                       aria-valuemax="100">{{ getLoggedPercentageAgainstEstimated(row) | truncateNumber }}%
                  </div>
                </div>
              </td>
              <td>
                <div class="progress m-0" style="height: 18px;">
                  <div class="progress-bar" role="progressbar"
                       [ngClass]="{'bg-danger': getLoggedPercentage(row)>100,
                              'bg-success': getLoggedPercentage(row)<=100}"
                       [style.width.%]="getLoggedPercentage(row)"
                       aria-valuemin="0" aria-valuemax="100">{{ getLoggedPercentage(row) | truncateNumber }}%
                  </div>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <div>
          <div class="d-flex">
            <ul class="navbar-nav d-flex flex-row flex-wrap gap-2 mb-2 mb-lg-0 ms-auto">
              <li class="nav-item" *ngFor="let releaseDetailLink of releases;let j = index">
                <a [routerLink]="[]" [fragment]="'eRelease'+j" class="nav-link px-2" *ngIf="j<i || j>i+1">
                  {{ releaseDetailLink.release?.name }}</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
