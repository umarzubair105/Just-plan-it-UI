<div class="container-fluid px-4">

  <<div class="card mb-2 mt-2">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="bi bi-box me-2"></i> Planned releases</h4>
    </div>
    <div class="card-body bg-white">
      <div class="d-flex">
        <ul class="navbar-nav d-flex flex-row flex-wrap gap-2 mb-2 mb-lg-0 ms-auto">
          <li class="nav-item" *ngFor="let releaseDetailLink of releases;let i = index">
            <a [routerLink]="[]" [fragment]="'plannedRelease'+i" class="nav-link px-2" *ngIf="i>0">
              {{ releaseDetailLink.release?.name }}</a>
          </li>
        </ul>
      </div>

      <div class="row release" *ngFor="let releaseDetail of releases;let i = index" [id]="'plannedRelease'+i">
        <!-- Release Details -->
        <div class="mb-2 p-2 border rounded d-flex justify-content-between align-items-center flex-wrap release-info">
          <div class="release-info-text text-dark text-center">
            Release: {{ releaseDetail.release?.name }} &nbsp;|&nbsp;
            Start Date: <strong>{{ releaseDetail.release?.startDate }}</strong> &nbsp;|&nbsp;
            End Date: <strong>{{ releaseDetail.release?.endDate }}</strong> &nbsp;|&nbsp;
            Working Days: {{ releaseDetail.release?.workingDays }}
          </div>

          <div class="mt-2 mt-lg-0">
            <button class="btn btn-sm me-2"
                    *ngIf="isManager(this.rights) && isDateStarted(releaseDetail.release.startDate)"
                    (click)="startRelease(releaseDetail)" title="Start working on release.">
              <i class="bi bi-play"></i> Start
            </button>
            <button class="btn btn-sm me-2"
                    *ngIf="isManager(this.rights)"
                    (click)="unplanRelease(releaseDetail)" title="Un plan the release.">
              <i class="bi bi-stop-circle"></i> Remove from plan
            </button>
          </div>
        </div>


        <div class="table-responsive mb-2">
          <ngx-datatable
              class="bootstrap-table table-striped table-bordered table-hover"
              [rows]="releaseDetail.epics"
              [columnMode]="'force'"
              [headerHeight]="40"
              [footerHeight]="40"
              [rowHeight]="'auto'"
              [sorts]="[{ prop: 'priorityLevel', dir: 'asc' }]"
              [rowClass]="getRowClass"
            >

              <ngx-datatable-column name="Code" prop="code" [sortable]="true" [width]="80" [minWidth]="80"
                                    [maxWidth]="80"></ngx-datatable-column>
              <ngx-datatable-column name="Title" prop="title">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  {{ row.title }}
                </ng-template>
              </ngx-datatable-column>
              <ngx-datatable-column name="Dependends On">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <div [innerHTML]="relationData(row.dependsOn, EpicLinkType.DEPEND_ON, false)"
                       *ngIf="row.dependsOn && row.dependsOn.length>0"></div>
                </ng-template>
              </ngx-datatable-column>
              <ngx-datatable-column name="Related To">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <div [innerHTML]="relationData(row.relatedTo, EpicLinkType.RELATED_TO, false)"
                       *ngIf="row.relatedTo && row.relatedTo.length>0"></div>
                </ng-template>
              </ngx-datatable-column>
              <ngx-datatable-column name="Priority" prop="priorityLevel" [sortable]="true" [width]="120"
                                    [minWidth]="120" [maxWidth]="120">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  {{ row.priorityName }}
                  <a (click)="changePriorityToUpper(row)" title="Move it to higher priority"
                     *ngIf="showChangePriorityToUpper(row)">
                    <i class="bi bi-arrow-up-short action-icon"></i>
                  </a>
                  <a (click)="changePriorityToLower(row)" title="Move it to lower priority"
                     *ngIf="showChangePriorityToLower(row)">
                    <i class="bi bi-arrow-down-short action-icon"></i>
                  </a>

                </ng-template>
              </ngx-datatable-column>
              <ngx-datatable-column name="Required By" prop="requiredBy" [maxWidth]="100"></ngx-datatable-column>
              <ngx-datatable-column name="Value Gain" prop="valueGain" [maxWidth]="80"></ngx-datatable-column>
              <ngx-datatable-column name="Assignment" [maxWidth]="300">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <div [innerHTML]="showAssignments(row.assignments)"></div>
                </ng-template>
              </ngx-datatable-column>
              <ngx-datatable-column name="Actions" [maxWidth]="150" [headerClass]="'text-center'">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <div style="text-align: center;">
                  <a (click)="unplanEpic(row.id, releaseDetail.release.id)"
                     title="Remove it from release plan"
                     *ngIf="isManager(this.rights)"  class="btn btn-sm">
                    <i class="bi bi-dash-square"></i>
                  </a>
                  </div>
                </ng-template>
              </ngx-datatable-column>
            </ngx-datatable>
        </div>
        <div class="table-responsive mb-2">
          <ngx-datatable
              [rows]="releaseDetail.resourceCaps"
              [columnMode]="'force'"
              [headerHeight]="40"
              [footerHeight]="0"
              [rowHeight]="'auto'"
              class="material">
              <ngx-datatable-column name="Resource" prop="resourceName"></ngx-datatable-column>
              <ngx-datatable-column name="Availability" [width]="150" [minWidth]="150" [maxWidth]="150">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  {{ row.prodBasedAssignableTime | decimalToTime }}
                </ng-template>
              </ngx-datatable-column>
              <ngx-datatable-column name="Time Assigned" [width]="150" [minWidth]="150" [maxWidth]="150">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  {{ row.prodBasedAssignedTime | decimalToTime }}
                </ng-template>
              </ngx-datatable-column>
              <ngx-datatable-column name="Time Unassigned" [width]="150" [minWidth]="150" [maxWidth]="150">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  {{ row.prodBasedAssignableTime - row.prodBasedAssignedTime | decimalToTime }}
                </ng-template>
              </ngx-datatable-column>
              <ngx-datatable-column name="Time Utilization" [width]="500" [minWidth]="500" [maxWidth]="500">
                <ng-template let-row="row" ngx-datatable-cell-template>
                  <div class="progress m-1" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         [ngClass]="{'bg-danger': getAssignedPercentage(row)>100,
                              'bg-primary': getAssignedPercentage(row)<=100}"
                         [style.width.%]="getAssignedPercentage(row)"
                         aria-valuemin="0" aria-valuemax="100">{{ getAssignedPercentage(row) | truncateNumber }}%
                    </div>
                  </div>
                  <!--<div class="time-bar-container">

                    <div
                      class="time-bar-assigned"
                      [style.width.%]="getAssignedPercentage(row)"
                      title="Time Assigned: {{ row.prodBasedAssignedTime | decimalToTime }}">
                    </div>
                    <div
                      class="time-bar-remaining"
                      [style.width.%]="100 - getAssignedPercentage(row)"
                      title="Time Unassigned: {{ row.prodBasedAssignableTime - row.prodBasedAssignedTime | decimalToTime }}">
                    </div>
                  </div>-->
                </ng-template>
              </ngx-datatable-column>
            </ngx-datatable>
        </div>
        <div>
          <div class="d-flex">
            <ul class="navbar-nav d-flex flex-row flex-wrap gap-2 mb-2 mb-lg-0 ms-auto">
              <li class="nav-item" *ngFor="let releaseDetailLink of releases;let j = index">
                <a [routerLink]="[]" [fragment]="'plannedRelease'+j" class="nav-link px-2" *ngIf="j<i || j>i+1">
                  {{ releaseDetailLink.release?.name }}</a>
              </li>
            </ul>
          </div>
        </div>
    </div>
  </div>
</div>
